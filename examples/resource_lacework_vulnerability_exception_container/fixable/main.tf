terraform {
  required_providers {
    lacework = {
      source = "lacework/lacework"
    }
  }
}

resource "lacework_vulnerability_exception_container" "example" {
  name        = var.name
  description = var.description
  expiry      = var.expiry
  reason      = "Accepted Risk"
  vulnerability_criteria {
    fixable_vuln = var.fixable
    severities   = ["Info", "Low"]
    cves         = var.cves
    package {
      name    = var.package_name
      version = var.package_version
    }
    package {
      name    = "adm-zip"
      version = "0.4.7"
    }
  }

  resource_scope {
    image_ids    = ["sha256:3b83d9104a4c4ccf76433756f14a2ad109e2aae15444b63339"]
    image_tags   = ["4.0", "1.0", "3.1", "5.0"]
    namespaces   = ["debian"]
    registries   = ["index.docker.io"]
    repositories = ["lacework/lacework-cli"]
  }
}

variable "name" {
  type    = string
  default = "Terraform Container Vulnerability Exception"
}

variable "description" {
  type    = string
  default = "Container Vulnerability Exception created by Terraform"
}

variable "expiry" {
  type    = string
  default = "2023-06-06T15:55:15Z"
}

variable "fixable" {
  type    = string
  default = null
}

variable "package_name" {
  type    = string
  default = "myPackage"
}

variable "package_version" {
  type    = string
  default = "1.0.0"
}


variable "cves" {
  type    = list(string)
  default = ["CVE-2016-9840", "cve-2018-14599", "CVE-2018-6942"]
}

output "name" {
  value = lacework_vulnerability_exception_container.example.name
}

output "description" {
  value = lacework_vulnerability_exception_container.example.description
}

output "cves" {
  value = lacework_vulnerability_exception_container.example.vulnerability_criteria.0.cves
}

output "packages" {
  value = lacework_vulnerability_exception_container.example.vulnerability_criteria.0.package
}

// we use coalesce() here just to return a string with the value of "null" when the output
// is actually nil - we do that to avoid drifts on a second terraform apply
output "fixable_vuln" {
  value = coalesce(lacework_vulnerability_exception_container.example.vulnerability_criteria.0.fixable_vuln, "null")
}

package integration

import (
	"testing"

	"github.com/gruntwork-io/terratest/modules/terraform"
	"github.com/stretchr/testify/assert"
)

// TestVulnerabilityExceptionHostCreate applies integration terraform:
// => '../examples/resource_lacework_vulnerability_exception_host'
//
// It uses the go-sdk to verify the created vulnerability exception,
// applies an update and destroys it
func TestVulnerabilityExceptionHostCreate(t *testing.T) {
	terraformOptions := terraform.WithDefaultRetryableErrors(t, &terraform.Options{
		TerraformDir: "../examples/resource_lacework_vulnerability_exception_host",
		EnvVars:      tokenEnvVar,
		Vars: map[string]interface{}{
			"name":            "Terraform Vulnerability Exception Host Test",
			"description":     "Vulnerability Exception Host created by Terraform",
			"cves":            []string{"CVE-2016-9840", "CVE-2018-14599", "CVE-2018-6942"},
			"package_name":    "myPackage",
			"package_version": "1.0.0",
		},
	})
	defer terraform.Destroy(t, terraformOptions)

	// Create new Vulnerability Exception
	create := terraform.InitAndApplyAndIdempotent(t, terraformOptions)
	createProps := GetVulnerabilityExceptionProps(create, 1)

	actualDescription := terraform.Output(t, terraformOptions, "description")
	actualCves := terraform.Output(t, terraformOptions, "cves")
	actualPackages := terraform.Output(t, terraformOptions, "packages")

	assert.Equal(t, "Vulnerability Exception Host created by Terraform", createProps.Data.Props.Description)
	assert.Equal(t, []string{"CVE-2016-9840", "CVE-2018-14599", "CVE-2018-6942"}, createProps.Data.VulnerabilityCriteria.Cve)
	assert.Equal(t, []map[string][]string{{"myPackage": {"1.0.0", "2.0.0"}}, {"myOtherPackage": {"1.0.0"}}}, createProps.Data.VulnerabilityCriteria.Package)

	assert.Equal(t, "Vulnerability Exception Host created by Terraform", actualDescription)
	assert.Equal(t, "[CVE-2016-9840 CVE-2018-14599 CVE-2018-6942]", actualCves)
	assert.Equal(t, "[map[name:myOtherPackage version:1.0.0] map[name:myPackage version:1.0.0] map[name:myPackage version:2.0.0]]", actualPackages)

	noexpiry := GetSpecificIDFromTerraResults(2, create)
	assert.NotEmpty(t, noexpiry)

	// Update Vulnerability Exception
	terraformOptions.Vars = map[string]interface{}{
		"name":            "Terraform Vulnerability Exception Host Test",
		"description":     "Updated Vulnerability Exception created by Terraform",
		"cves":            []string{"CVE-2016-9840", "CVE-2018-6940"},
		"package_name":    "myUpdatedPackage",
		"package_version": "1.1.0",
	}

	update := terraform.ApplyAndIdempotent(t, terraformOptions)
	updateProps := GetVulnerabilityExceptionProps(update, 1)
	actualDescription = terraform.Output(t, terraformOptions, "description")
	actualCves = terraform.Output(t, terraformOptions, "cves")
	actualPackages = terraform.Output(t, terraformOptions, "packages")

	assert.Equal(t, "Updated Vulnerability Exception created by Terraform", updateProps.Data.Props.Description)
	assert.Equal(t, []string{"CVE-2016-9840", "CVE-2018-6940"}, updateProps.Data.VulnerabilityCriteria.Cve)
	assert.Equal(t, []map[string][]string{{"myPackage": {"2.0.0"}}, {"myUpdatedPackage": {"1.1.0"}}, {"myOtherPackage": {"1.0.0"}}}, updateProps.Data.VulnerabilityCriteria.Package)

	assert.Equal(t, "Updated Vulnerability Exception created by Terraform", actualDescription)
	assert.Equal(t, "[CVE-2016-9840 CVE-2018-6940]", actualCves)
	assert.Equal(t, "[map[name:myOtherPackage version:1.0.0] map[name:myPackage version:2.0.0] map[name:myUpdatedPackage version:1.1.0]]", actualPackages)
}

package integration

import (
	"testing"

	"github.com/gruntwork-io/terratest/modules/terraform"
	"github.com/stretchr/testify/assert"
)

// TestVulnerabilityExceptionContainerCreate applies integration terraform:
// => '../examples/resource_lacework_vulnerability_exception_container/fixable'
//
// It uses the go-sdk to verify the created vulnerability exception,
// applies an update and destroys it
func TestVulnerabilityExceptionContainerCreate(t *testing.T) {
	terraformOptions := terraform.WithDefaultRetryableErrors(t, &terraform.Options{
		TerraformDir: "../examples/resource_lacework_vulnerability_exception_container/fixable",
		EnvVars:      tokenEnvVar,
		Vars: map[string]interface{}{
			"name":            "Terraform Vulnerability Exception Container Test",
			"description":     "Vulnerability Exception Container created by Terraform",
			"cves":            []string{"CVE-2016-9840", "CVE-2018-14599", "CVE-2018-6942"},
			"package_name":    "myPackage",
			"package_version": "1.0.0",
		},
	})
	defer terraform.Destroy(t, terraformOptions)

	// Create new Vulnerability Exception
	create := terraform.InitAndApplyAndIdempotent(t, terraformOptions)
	createProps := GetVulnerabilityExceptionProps(create)

	actualDescription := terraform.Output(t, terraformOptions, "description")
	actualCves := terraform.Output(t, terraformOptions, "cves")
	actualPackages := terraform.Output(t, terraformOptions, "packages")
	actualFixable := terraform.Output(t, terraformOptions, "fixable_vuln")

	assert.Equal(t, "Vulnerability Exception Container created by Terraform", createProps.Data.Props.Description)
	assert.Equal(t, []string{"CVE-2016-9840", "CVE-2018-14599", "CVE-2018-6942"}, createProps.Data.VulnerabilityCriteria.Cve)
	assert.Equal(t, []map[string][]string{{"myPackage": {"1.0.0"}}, {"adm-zip": {"0.4.7"}}}, createProps.Data.VulnerabilityCriteria.Package)
	assert.Nil(t, createProps.Data.VulnerabilityCriteria.FixableEnabled())

	assert.Equal(t, "Vulnerability Exception Container created by Terraform", actualDescription)
	assert.Equal(t, "[CVE-2016-9840 CVE-2018-14599 CVE-2018-6942]", actualCves)
	assert.Equal(t, "[map[name:adm-zip version:0.4.7] map[name:myPackage version:1.0.0]]", actualPackages)
	assert.Equal(t, "null", actualFixable)

	// Update Vulnerability Exception
	terraformOptions.Vars = map[string]interface{}{
		"name":            "Terraform Vulnerability Exception Container Test",
		"description":     "Updated Vulnerability Exception created by Terraform",
		"cves":            []string{"CVE-2016-9840", "CVE-2018-6940"},
		"package_name":    "myUpdatedPackage",
		"package_version": "1.1.0",
		"fixable":         "true",
	}

	update := terraform.ApplyAndIdempotent(t, terraformOptions)
	updateProps := GetVulnerabilityExceptionProps(update)
	actualDescription = terraform.Output(t, terraformOptions, "description")
	actualCves = terraform.Output(t, terraformOptions, "cves")
	actualPackages = terraform.Output(t, terraformOptions, "packages")

	assert.Equal(t, "Updated Vulnerability Exception created by Terraform", updateProps.Data.Props.Description)
	assert.Equal(t, []string{"CVE-2016-9840", "CVE-2018-6940"}, updateProps.Data.VulnerabilityCriteria.Cve)
	assert.Equal(t, []map[string][]string{{"myUpdatedPackage": {"1.1.0"}}, {"adm-zip": {"0.4.7"}}}, updateProps.Data.VulnerabilityCriteria.Package)

	assert.Equal(t, "Updated Vulnerability Exception created by Terraform", actualDescription)
	assert.Equal(t, "[CVE-2016-9840 CVE-2018-6940]", actualCves)
	assert.Equal(t, "[map[name:adm-zip version:0.4.7] map[name:myUpdatedPackage version:1.1.0]]", actualPackages)

	// run update again to set fixable back to nil by not passing the variable
	terraformOptions.Vars = map[string]interface{}{
		"name":            "Terraform Vulnerability Exception Container Test",
		"description":     "Updated Vulnerability Exception created by Terraform",
		"cves":            []string{"CVE-2016-9840", "CVE-2018-6940"},
		"package_name":    "myUpdatedPackage",
		"package_version": "1.1.0",
	}

	updateAgain := terraform.ApplyAndIdempotent(t, terraformOptions)
	updatePropsAgain := GetVulnerabilityExceptionProps(updateAgain)
	assert.Nil(t, updatePropsAgain.Data.VulnerabilityCriteria.FixableEnabled())

}

// TestVulnerabilityExceptionContainerCreateFixableUnset applies integration terraform:
// => '../examples/resource_lacework_vulnerability_exception_container/fixable_unset'
//
// It uses the go-sdk to verify the created vulnerability exception,
// applies an update and destroys it
func TestVulnerabilityExceptionContainerCreateFixableUnset(t *testing.T) {
	terraformOptions := terraform.WithDefaultRetryableErrors(t, &terraform.Options{
		TerraformDir: "../examples/resource_lacework_vulnerability_exception_container/fixable_unset",
		EnvVars:      tokenEnvVar,
		Vars: map[string]interface{}{
			"name":            "Terraform Vulnerability Exception Container Test",
			"description":     "Vulnerability Exception Container created by Terraform",
			"cves":            []string{"CVE-2016-9840", "CVE-2018-14599", "CVE-2018-6942"},
			"package_name":    "myPackage",
			"package_version": "1.0.0",
		},
	})
	defer terraform.Destroy(t, terraformOptions)

	// Create new Vulnerability Exception
	create := terraform.InitAndApplyAndIdempotent(t, terraformOptions)

	// check resource with fixable unset
	unsetFixableResource := GetVulnerabilityExceptionProps(create)
	assert.Nil(t, unsetFixableResource.Data.VulnerabilityCriteria.FixableEnabled())

	// Update Vulnerability Exception
	terraformOptions.Vars = map[string]interface{}{
		"name":            "Terraform Vulnerability Exception Container Test",
		"description":     "Updated Vulnerability Exception created by Terraform",
		"cves":            []string{"CVE-2016-9840", "CVE-2018-6940"},
		"package_name":    "myUpdatedPackage",
		"package_version": "1.1.0",
	}

	update := terraform.ApplyAndIdempotent(t, terraformOptions)
	updateProps := GetVulnerabilityExceptionProps(update)

	assert.Nil(t, updateProps.Data.VulnerabilityCriteria.FixableEnabled())
}
